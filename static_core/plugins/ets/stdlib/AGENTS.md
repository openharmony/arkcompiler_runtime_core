# AGENTS.md

This file provides guidance to AI agents when working with code in this repository.

## Project Overview

This is the **ETS (Extended TypeScript) Standard Library** for the **ArkCompiler runtime**, which is part of the OpenHarmony application development framework. The stdlib provides core types, collections, concurrency primitives, and ECMAScript compatibility layers for ArkTS applications.

> **ðŸ’¡ Note**: Language reference for ArkTS 1.2 should be available in project documentation or OpenHarmony SDK docs.

### Architecture

The stdlib is organized into several layers:

- **`std/core/`** - Core ArkTS types (Array, String, Promise, primitive wrappers, reflection types)
- **`std/concurrency/`** - Multi-threading primitives (taskpool, workers, AsyncLock, Atomics)
- **`std/containers/`** - Data structures (HashMap, TreeMap, TreeSet, Queue, LinkedList)
- **`std/interop/`** - JavaScript-ETS interoperation bridge
- **`std/testing/`** - ArkTest unit testing framework
- **`std/debug/`** - Debug utilities (not implicitly imported)
- **`escompat/`** - ECMAScript compatibility layer (TypedArrays, Error, Functions, Global)
- **`native/core/`** - C++ native implementations (Intl, RegExp, Process)

### Module System

- Every file declares a package: `package std.core;` (or `package escompat;`, etc.)
- Module imports use path mappings from `stdconfig.json`:
  - `"std"` maps to `"ets/stdlib/std"`
  - `"escompat"` maps to `"ets/stdlib/escompat"`
- Files in `escompat/` provide JS-compatible APIs
- Files in `std/` provide ArkTS-specific enhancements
- **Import syntax**: `import { HashMap } from 'std.containers'` or `import * as escompat from 'escompat'`

## Build System

This project uses **dual build systems**:


### CMake Build (Primary to project)
```bash
# Build Panda runtime from static_core root
cd ../../../
cmake -B build -DCMAKE_BUILD_TYPE=Release -GNinja \
    -DCMAKE_TOOLCHAIN_FILE=cmake/toolchain/host_clang_14.cmake \
    -S . -Werror=dev  -DPANDA_WITH_TESTS=ON\
    -DPANDA_ETS_INTEROP_JS=ON
cmake --build build --target panda_bins etssdk
```

### GN Build 
```bash
gn gen out/default
ninja -C out/default
```

Key targets:
- `copy_stdlib` - Copies and processes stdlib files using `package_stdlib.py`

### Python Packaging
```bash
python3 package_stdlib.py --std-dir std --escompat-dir escompat --target-dir out/arkcompiler/stdlib --json-file hiddable_APIs.json
```

The `package_stdlib.py` script filters APIs based on `hiddable_APIs.json` (located in the build tree), removing `export` keywords from specified interfaces to hide them in certain builds.

## Code Style Guidelines

### Spacing
- **4-space indentation** (no tabs)
- Every file must start with: `package std.core;` (or appropriate package path)
- Remove trailing whitespaces
- File must end with **single empty line**
- Space after colon in type annotations: `let x: number | null = null`
- Spaces around operators: `a * b + c`
- Space after `if`, `while` before `(`: `if (condition) {`

### Braces
- Open brace `{` on same line, space before it: `if (ok) {`
- Close brace `}` on new line
- Single-line blocks: `if (status == 200) { return true; }`
- `else` placement:
  ```typescript
  if (ok) { console.log('123') }
  else { console.log('345') }
  ```
- Empty braces on same line: `function nop(): void {}`

### Vertical Spaces
- Max 2 lines in declarations, 1 line in code
- Group related fields without space, separate logical groups with 1 line

### Naming Conventions
- **Types**: PascalCase - `VeryLongTypeName`
- **Methods/properties**: camelCase - `myMethod`, `xmlParser`
- **Constants**: UPPER_SNAKE_CASE - `NOT_USED`
- **No prefixes/suffixes** (no Hungarian notation, no `_` prefix)

### Visibility Modifiers
- Explicit `public` and `override` required
- Prefer most restrictive applicable: `public` < `protected` < `private`

### Local Variables
- Prefer `const` over `let`
- Add explicit type annotations: `let item: string = "foo"`
- Avoid shadowing

### Exception Handling
- Use `Error` for bugs (e.g., invalid arguments) and for expected exceptional paths (e.g., file not found)
- Minimize code in `try`-`catch`-`finally` blocks
- Never `return` from `finally`

### Comments
- Doc comments start with `/**` ends with `*/`
- Code comments: `// Comment` (space after `//`)
- Commented out code: `//if` (no space after `//`)

### Switch Statements
- Always add `default` case if not exhaustive
- Use `arktest.assertFalse(true)` in unreachable cases with comments why it added
- Mark fallthrough: `// fallthrough`

## Code Generation

Many files are **autogenerated from templates**. These files start with:
```typescript
// NOTE: autogenerated file
```

**DO NOT edit autogenerated files directly.** Instead, modify the corresponding template in `../templates/stdlib/`:

### Template Types
- **Jinja2** (`.j2`): `TypedArray.ets.j2` â†’ `TypedArrays.ets`
- **ERB** (`.erb`): `Array_escompat.erb` â†’ `Array.ets`

### Regeneration Script
After modifying templates, regenerate files:
```bash
export PROJECT=/path/to/static_core
chmod +x $PROJECT/plugins/ets/templates/stdlib/genlib.sh
$PROJECT/plugins/ets/templates/stdlib/genlib.sh
```

**Commit both template changes AND generated files together.** The build system validates consistency between templates and generated files.

### Key Template Mappings
- `TypedArray.ets.j2` â†’ `escompat/TypedArrays.ets`
- `TypedUArray.ets.j2` â†’ `escompat/TypedUArrays.ets`
- `Array_escompat.erb` â†’ `std/core/Array.ets`
- `Array_builtin.erb` â†’ `std/core/BuiltinArray.ets`
- `Array_common.erb` â†’ `BuiltinArray.ets` and `Array.ets`
- `Function.ets.j2` â†’ `escompat/Functions.ets`
- `Tuple.ets.j2` â†’ `std/core/Tuple.ets`
- `DataView.ets.j2` â†’ `std/core/DataView.ets`
- `InteropTransferHelper.ets.j2` â†’ `std/interop/js/InteropTransferHelper.ets`

## File Headers

All ETS files must include the Apache 2.0 license header:
```typescript
/*
 * Copyright (c) 2021-2026 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
```

## Testing

The built-in **ArkTest** framework is defined in `std/testing/`. Usage pattern:

```typescript
function main(): int {
    let myTestsuite = new arktest.ArkTestsuite("myTestsuite");
    myTestsuite.addTest("TestName", () => {
        arktest.assertEQ(actual, expected);
        arktest.expectError(() => { throw new Error() }, new Error());
    });
    return myTestsuite.run(); // MUST return the count of failed tests
}
```

**Critical**: Always return the test suite result from `main()`. Never return constant values like `true` or `0`.

## Native Integration

- Native methods marked with `native` keyword
- C++ implementations in `native/core/`
- ANI (Ark Native Interface) native interface for FFI
- Native layer provides: Intl (ICU4C integration), RegExp engine, Process management and other things like Reflect

## Module-Specific Notes

### Concurrency (`std/concurrency/`)
- Task pool for thread-based execution
- Worker support for multi-threading
- AsyncLock, Atomics, SyncPrimitives for synchronization
- Message passing primitives

### Interop (`std/interop/`)
- JSValue, JSRuntime for JavaScript bridge
- Serialization/deserialization helpers
- Promise interop layer

### Containers (`std/containers/`)
- AVL tree-based TreeMap/TreeSet (uses Jinja2 for generics)
- HashMap, HashSet, LinkedList, Queue, Stack
- See `std/containers/README.md` for template usage

### Debug (`std/debug/`)
- Provide api for debug and log

## Troubleshooting

- **Build fails after template changes**: Ensure you ran `genlib.sh` and committed both template and generated files
- **Import errors**: Check `stdconfig.json` for path mappings; use full import paths like `std.core.Array`
- **Test suite returns wrong value**: Always return `myTestsuite.run()` from `main()`, not constants and fix tests
- **Autogenerated file edits lost**: Files starting with `// NOTE: autogenerated file` are regenerated from templates in `../templates/stdlib/`
- **Missing hiddable_APIs.json**: This file is provided by the build system, not tracked in stdlib

## Local Development Tools

### SKILLS Directory

The `SKILLS/` folder contains custom AI agent skills for stdlib development. Each skill includes reference documentation, automation scripts, and specialized workflows.

#### Available Skills

- **arktest-generator** - Generate ArkTest unit tests for stdlib APIs
- **build-stdlib** - Build stdlib using CMake from project root (../../../)
- **concurrent-programming** - Multi-threading, async/await, synchronization, concurrent data structures, concurrency safety checking
- **copyright** - Manage Apache 2.0 license headers in source files
- **internationalization** - Unicode, ICU, locale handling, i18n APIs
- **native-integration** - C++ programming, FFI, ANI, ICU4C integration, native integration validation
- **urunner-stdlib** - Run ets_func_tests using Universal Runner from tests/tests-u-runner-2/

For detailed skill documentation and learning paths, see `SKILLS/README.md`.

### CMake Build (Local Development)
For local development, CMake can be used instead of GN:
```bash
cd ../../../  # to runtime_core root
cmake -B build -DCMAKE_BUILD_TYPE=Release -GNinja \
    -DCMAKE_TOOLCHAIN_FILE=cmake/toolchain/host_clang_14.cmake \
    -S . -Werror=dev  -DPANDA_WITH_TESTS=ON\
    -DPANDA_ETS_INTEROP_JS=ON
cmake --build build --target panda_bins etssdk
```

### Universal Runner (urunner)
Requires `~/.urunner.env` with ARKCOMPILER_RUNTIME_CORE_PATH, PANDA_BUILD, and WORK_DIR variables.

Always use `--filter` option to filter affected api, to check which tests are affected need to check `../tests/ets_func_tests/std/`. 
Example: `--filter std/core/json` if changed json api. If changed `Intl` need to use `--filter/std/core/Intl*`.

Execute ets_func_tests from `../../../tests/tests-u-runner-2/`:
```bash
cd ../../../ # from current dir
PANDA_BUILD="build" ARKCOMPILER_RUNTIME_CORE_PATH="../" ARKCOMPILER_ETS_FRONTEND_PATH="tools/es2panda/" ./runner.sh \
  panda-int ets-func-tests --show-progress --force-generate --processes=all 
```

Execute checker_tests from `../../../tests/tests-u-runner-2/`:
```bash
cd ../../../tests/tests-u-runner-2/
./runner.sh checker compiler_checker_suite --show-progress --force-generate --processes=all
```

## Copyright Headers

### Shell Scripts (.sh files)
Shell scripts use `#` comment prefix for Apache 2.0 header:
```bash
#!/bin/bash
#
# Copyright (c) 2026 Huawei Device Co., Ltd.
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
```
